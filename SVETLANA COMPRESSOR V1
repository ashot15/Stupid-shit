import sys
import numpy as np
import pywt
import lzma
import cv2
import pickle
from PyQt5.QtWidgets import QApplication, QWidget, QPushButton, QLabel, QFileDialog, QVBoxLayout
from PyQt5.QtGui import QPixmap, QImage
from PyQt5.QtCore import Qt

# === Функции сжатия ===
def wavelet_transform(image, wavelet_type='haar', level=1):
    """Применяет дискретное вейвлет-преобразование к каждому цветовому каналу."""
    coeffs_r = pywt.wavedec2(image[:, :, 0], wavelet_type, level=level)
    coeffs_g = pywt.wavedec2(image[:, :, 1], wavelet_type, level=level)
    coeffs_b = pywt.wavedec2(image[:, :, 2], wavelet_type, level=level)
    return (
        pywt.coeffs_to_array(coeffs_r),
        pywt.coeffs_to_array(coeffs_g),
        pywt.coeffs_to_array(coeffs_b)
    )

def custom_compression(image, wavelet_type='haar', level=1):
    """Сжатие изображения с использованием LZMA."""
    coeffs_r, coeffs_g, coeffs_b = wavelet_transform(image, wavelet_type, level)
    compressed_data = lzma.compress(np.hstack((coeffs_r[0].flatten(), coeffs_g[0].flatten(), coeffs_b[0].flatten())).astype(np.float32), preset=9)
    return compressed_data, (coeffs_r[1], coeffs_g[1], coeffs_b[1]), image.shape, {'wavelet_type': wavelet_type, 'level': level}

# === GUI для сжатия изображений ===
class ImageCompressorApp(QWidget):
    def __init__(self):
        super().__init__()
        self.initUI()

    def initUI(self):
        self.setWindowTitle("Svetlana Image Compressor")
        self.setGeometry(100, 100, 500, 500)
        self.setStyleSheet("background-color: #333; color: white;")
        self.label = QLabel("Выберите изображение для сжатия", self)
        self.label.setAlignment(Qt.AlignCenter)
        self.label.setStyleSheet("font-size: 16px; padding: 10px;")
        self.button_select = QPushButton("Выбрать изображение", self)
        self.button_select.setStyleSheet("background-color: #555; color: white; font-size: 14px;")
        self.button_select.clicked.connect(self.select_image)
        self.button_compress = QPushButton("Сжать и сохранить", self)
        self.button_compress.setStyleSheet("background-color: #777; color: white; font-size: 14px;")
        self.button_compress.clicked.connect(self.compress_image)
        self.button_compress.setEnabled(False)
        self.layout = QVBoxLayout()
        self.layout.addWidget(self.label)
        self.layout.addWidget(self.button_select)
        self.layout.addWidget(self.button_compress)
        self.setLayout(self.layout)
        self.image_path = None

    def select_image(self):
        file_path, _ = QFileDialog.getOpenFileName(self, "Выберите изображение", "", "Images (*.png *.jpg *.jpeg *.bmp)")
        if file_path:
            self.image_path = file_path
            pixmap = QPixmap(file_path)
            self.label.setPixmap(pixmap.scaled(300, 300, Qt.KeepAspectRatio))
            self.button_compress.setEnabled(True)

    def compress_image(self):
        if not self.image_path:
            return
        try:
            image = cv2.imread(self.image_path)
            if image is None:
                raise ValueError("Не удалось загрузить изображение.")
            image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)  # OpenCV загружает в BGR, переводим в RGB
            compressed_data, coeffs_slices, shape, params = custom_compression(image, wavelet_type='haar', level=1)
            save_path, _ = QFileDialog.getSaveFileName(self, "Сохранить сжатый файл", "", "Svetlana Format (*.svetlana)")
            if save_path:
                with open(save_path, 'wb') as f:
                    pickle.dump((compressed_data, coeffs_slices, shape, params), f)
                self.label.setText("Файл успешно сжат и сохранён!")
        except Exception as e:
            self.label.setText(f"Произошла ошибка: {str(e)}")

# Запуск приложения
if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = ImageCompressorApp()
    window.show()
    sys.exit(app.exec_())
